name: Release

on:
  push:
    tags:
      - "**[0-9]+.[0-9]+.[0-9]+*"

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        # To build Cpython 3.8.2, msvc v140 VS2015 C++ is required but not included in windows-2022, so build with 2019.
        os: [windows-2019]

    steps:
      - uses: actions/checkout@v3

      # Generated by https://ddalcino.github.io/aqt-list-server/
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          aqtversion: "==3.1.*"
          version: "5.15.2"
          host: "windows"
          dir: "${{ github.workspace}}/"
          target: "desktop"
          tools: "tools_ifw tools_qtcreator,qt.tools.qtcreator"
          #? 5.14.2 is msvc2017, but action env support 2019, 2022 only . So we use this.
          arch: "win32_msvc2019"
          cache: true

      - name: Set up cmake deps cache
        uses: actions/cache@v3
        with:
          path: ./build
          key: cmake-build-${{ runner.os }}-${{ hashFiles('./CMakeLists.txt') }}
          restore-keys: cmake-build.${{ runner.os }}.

      - name: Setup & Build CMake
        shell: pwsh
        run: ./build.ps1 -Verbose -Deploy

      - name: Update CHANGELOG
        id: changelog
        uses: requarks/changelog-action@v1 # requires a minimum of two tags.
        with:
          token: ${{ github.token }}
          tag: ${{github.ref_name}}
        if: github.ref_name != '0.1.0'
        continue-on-error: true

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: NemesisUnlimitedBehaviorEngine-v${{github.ref_name}}
          body: ${{ steps.changelog.outputs.changes }}
          files: ./NemesisUnlimitedBehaviorEngine-x86-windows-msvc.zip
